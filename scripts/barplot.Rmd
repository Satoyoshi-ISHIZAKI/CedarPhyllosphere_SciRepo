---
title: "barplot"
output: html_document
date: "2024-10-10"
---

#load packages

```{r}
library(readxl)
library(tidyverse)
library(phyloseq)
library(fantaxtic)
library(ggnested)
library(ggtext)
library(gridExtra)
library(grid)
library(gtable)
```

#path to raw-data directory (change "path" to your raw-data directory)

```{r}
#create "path" file, and define "path" as your raw-data directory(character vector) in the file
#"path" is raw-data directory, and "path_out" is output file directory

source("../scripts/path.R")
```

#source codes
```{r}
source("../R/label.R")
```

#read processed data
##16S

```{r import}
otus_16S <- read.csv(paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/otus_data_16S.csv"), row.names = 1)
rownames(otus_16S) <- formatC(as.numeric(rownames(otus_16S)), width = 4, flag = "0") #add 0 to rownames

#tax_table
tax_16S <- read.csv(paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/tax_table2_16S.csv"), row.names = 1)
tax_16S <- as.matrix(tax_16S)

#phylogenetic tree
load(paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/trees.Rdata"))
tree16S <- tree2
tree16S_rarefied <- tree_rarefied2
rm(list = c("tree2", "tree_rarefied2"))

#metadata
metadata <- read_excel(paste0(path_out, "/data/Sugi/metadata_2306.xlsx"), sheet = "Sheet1")
metadata <- column_to_rownames(metadata, var = "Sample_Name")
metadata$cloneID <- as.factor(metadata$cloneID)
metadata$population <- as.factor(metadata$population)
metadata$site <- as.factor(metadata$site)
metadata$date <- as.factor(metadata$date)
```

##ITS

```{r}
otus_ITS <- read.csv(paste0(path_out, "/231202_Sugi_phyllosphere_June_ITS/processed_data/otus_data_ITS.csv"), row.names = 1)
rownames(otus_ITS) <- formatC(as.numeric(rownames(otus_ITS)), width = 4, flag = "0") #add 0 to rownames

#tax_table
tax_ITS <- read.csv(paste0(path_out, "/231202_Sugi_phyllosphere_June_ITS/processed_data/tax_table2_ITS.csv"), row.names = 1)
tax_ITS <- as.matrix(tax_ITS)

#phylogenetic tree
load(paste0(path_out, "/231202_Sugi_phyllosphere_June_ITS/processed_data/trees.Rdata"))
treeITS <- tree2
treeITS_rarefied <- tree_rarefied2
rm(list = c("tree2", "tree_rarefied2"))
```


```{r}
# add clone_ID to rownames (why needed?)
rownames(otus_16S) <- paste0(rownames(metadata), "_", metadata$population)
rownames(otus_ITS) <- paste0(rownames(metadata), "_", metadata$population)
rownames(metadata) <- paste0(rownames(metadata), "_", metadata$population)
```

#phyloseq_object

```{r barplot}
ps_16S <- phyloseq(otu_table(otus_16S, taxa_are_rows = F), 
                 tax_table(tax_16S), 
                 phy_tree(tree16S$data), 
                 sample_data(metadata)) #change row indices to choose samples included in barplots
ps_ITS <- phyloseq(otu_table(otus_ITS, taxa_are_rows = F), 
                 tax_table(tax_ITS), 
                 phy_tree(treeITS$data), 
                 sample_data(metadata))
```

#plot
##16S

```{r, cache=TRUE, dependson="barplot"}
#select highly abundant taxa
top_16S <- nested_top_taxa(ps_obj = ps_16S, 
                           top_tax_level = "Phylum",
                           n_top_taxa = 2,
                           nested_tax_level = "Genus", 
                           n_nested_taxa = 3, 
                           grouping = "site")
```

```{r}
p_16S <- plot_nested_bar(ps_obj = top_16S$ps_obj, 
                         top_level = "Phylum", 
                         nested_level = "Genus") +
  theme_classic() +
  facet_wrap(~ site, scales = "free_x") +
  labs(y = "Relative Abundance") +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        
        strip.background.x = element_rect(color = "black", fill = "white"),
        legend.text = element_markdown(), 
        legend.key.size = unit(1.5, "mm"))

show(p_16S)
ggsave(plot = p_16S, filename = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/figures/barplot_16S.png"), 
       dpi = 400, width = 150, height = 80, units = "mm")
#(A4, margin = c(25.4, 25.4), units = "mm")
```

##ITS

```{r}
top_ITS <- nested_top_taxa(ps_obj = ps_ITS, 
                           top_tax_level = "Class",
                           n_top_taxa = 3,
                           nested_tax_level = "Genus", 
                           n_nested_taxa = 2,
                           grouping = "site")
```

```{r}
p_ITS <- plot_nested_bar(ps_obj = top_ITS$ps_obj, 
                      top_level = "Class", 
                      nested_level = "Genus") +
  theme_classic() +
  facet_wrap(~ site, scales = "free_x") +
  labs(y = "Relative Abundance") +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        
        strip.background.x = element_rect(color = "black", fill = "white"),
        legend.text = element_markdown(), 
        legend.key.size = unit(1.5, "mm"))

show(p_ITS)
ggsave(plot = p_ITS, filename = paste0(path_out, "/231202_Sugi_phyllosphere_June_ITS/figures/barplot_ITS.png"), 
       dpi = 400, width = 150, height = 80, units = "mm")
#(A4, margin = c(25.4, 25.4), units = "mm")
```

#arrange tow plots

```{r}
p_16S_label <- arrangeGrob(p_16S, top = create_label("a"))
p_ITS_label <- arrangeGrob(p_ITS, top = create_label("b"))

p_two_bar <- grid.arrange(p_16S_label, p_ITS_label, nrow = 1)
ggsave(p_two_bar, filename = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/figures/barplot_both.png"), 
       dpi = 400, width = 150, height = 80, units = "mm", scale = 2)
```

