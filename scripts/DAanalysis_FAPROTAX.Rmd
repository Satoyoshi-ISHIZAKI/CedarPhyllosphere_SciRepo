---
title: "DAanalysis_FAPROTAX"
output: html_document
date: "2026-01-09"
---

# Workflow to this script:
1. Pre-processing_16S.Rmd
2. rarefaction_16S.Rmd
3. NMDS_16S.Rmd
4. envfit_ASV_16S.Rmd
5. BVOC_preprocessing.Rmd
7. envfit_BVOC_LODrev.Rmd
6. FAPROTAX_prep
8. FAPROTAX_analysis.Rmd
9. clean_tsv_fapro.R
10. DAanalysis_FAPROTAX.Rmd (this file)

# load packages

```{r,include=FALSE}
library(readxl)
library(phyloseq)
library(tidyverse)
library(vegan)
library(Maaslin2)
library(SummarizedExperiment)
library(ggnewscale)
library(viridis)
library(viridisLite)
```

# path to raw-data directory (change "path" to your raw-data directory)

```{r}
# create "path" file, and define "path" as your raw-data directory(character vector) in the file
# "path" is raw-data directory, and "path_out" is output file directory

source("../scripts/path.R")
```

# source codes

```{r}
source("../R/occurrence.R")
source("../R/plot_top_taxa.R")
```

# plot theme

```{r}
mytheme <-theme(text = element_text(color = "black"), 
                axis.text = element_text(color = "black")
                )
```

# data import
<details><summary>**data import**</summary><div>

## ps_object

```{r}
load(file = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/ps_fapro_nov.Rdata"))
```

## BVOC

```{r}
#read VOC data
load(file = paste0(path_out, "/data/Sugi/BVOC/exp_Terpene_2209to2408_LODrev_nolod.Rdata"))
load(file = paste0(path_out, "/data/Sugi/BVOC/exp_Terpene_2209to2408_LODrev_log.Rdata"))

#extract the data for June 2023
BVOC_2306 <- exp_Ohta_nolod %>% subset(Month == "2306")
BVOC_2306_log <- exp_Ohta_log %>% subset(Month == "2306")

#Longifolene is not detected in the June 2023 samples, so remove it
BVOC_2306 <- BVOC_2306[, -which(colnames(BVOC_2306) == "Longifolene")]
BVOC_2306 <- BVOC_2306_log[, -which(colnames(BVOC_2306_log) == "Longifolene")]

#remove beta-Caryophyllene from the dataframe
bCary <- which("beta-Caryophyllene" == colnames(BVOC_2306_log)) #the column number of beta-Caryophyllene
BVOC_2306_log_rm <- assay(BVOC_2306_log)[, -bCary] #remove beta-Caryophyllene
```

```{r}
#calculate log-transformed total BVOC- and MTs emission
BVOC_2306_total_log <- data.frame(total = log(rowSums(assay(BVOC_2306)), base = 10)) %>%
  rownames_to_column(var = "sampleID")
MT_2306_log <- data.frame(MTs = log(rowSums(assay(BVOC_2306[, BVOC_2306$mol_weight == "Mono"])) + 1, base = 10)) %>%
  rownames_to_column(var = "sampleID")
SQT_2306_log <- data.frame(SQT = log(rowSums(assay(BVOC_2306[, BVOC_2306$mol_weight == "Sesqui"])) + 1, base = 10)) %>%
  rownames_to_column(var = "sampleID")
DT_2306_log <- data.frame(DT = log(rowSums(assay(BVOC_2306[, BVOC_2306$mol_weight == "Di"])) + 1, base = 10)) %>%
  rownames_to_column(var = "sampleID")

#merge BVOC data
all_2306_log <- BVOC_2306_log_rm %>%
  rownames_to_column(var = "sampleID") %>%
  full_join(BVOC_2306_total_log, by = "sampleID") %>%
  full_join(MT_2306_log, by = "sampleID") %>%
  full_join(SQT_2306_log, by = "sampleID") %>%
  full_join(DT_2306_log, by = "sampleID")

# PCA results
load(paste0(path_out, "/data/Sugi/BVOC/pca_BVOC_2306_log_LODrev.Rdata"))
BVOC_pca <- data.frame(pca_BVOC_log_rm_LODrev$x)
colnames(BVOC_pca) <- paste(colnames(BVOC_pca), "ter", sep = "_")
BVOC_pca <- BVOC_pca %>% 
  rownames_to_column(var = "sampleID")

# merge PC1:3 to all_2306_log
all_2306_log <- all_2306_log %>% 
  left_join(BVOC_pca %>% dplyr::select(sampleID, PC1_ter, PC2_ter, PC3_ter), by = "sampleID") %>% 
  dplyr::filter(!is.na(PC1_ter)) %>% # remove samples with NA PC1_ter values (microbe data not available)
  dplyr::mutate(sampleID = paste(sapply(lapply(str_split(sampleID, "_"), `[`, 1:3), paste0, collapse = "_"), 
                                 substr(replace_na(sapply(str_split(sampleID, "_"), `[`, 4), "01"), 2, 2), 
                                 sep = "_")
                )

```

```{r}
#merge metadata
metadata <- data.frame(sample_data(ps_fapro_nov))
metadata <- metadata %>% 
  dplyr::mutate(sampleID = paste(paste0(substr(site, 1, 1), "2306"), 
                                 samplename, sep = "_")
                )

metadata <- metadata %>% 
  left_join(all_2306_log, by = "sampleID")
rownames(metadata) <- formatC(as.numeric(rownames(metadata)), width = 4, flag = "0")

# add to phyloseq
sample_data(ps_fapro_nov) <- sample_data(metadata)
```

</div></details>

# MaAsLin2
<details><summary>**DA analysis with MaAsLin2**</summary><div>

## Whole

```{r,message=FALSE}
DA_res <- Maaslin2(input_data = as.data.frame(t(otu_table(ps_fapro_nov)))[, -29], 
                   input_metadata = data.frame(sample_data(ps_fapro_nov)) %>% 
                     dplyr::select(site), 
                   output = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/Whole"), 
                   fixed_effects = c("site"), 
                   random_effects = NULL, 
                   analysis_method = "LM", 
                   transform = "LOG", 
                   normalization = "NONE", 
                   min_abundance = 0.0, 
                   min_prevalence = 0.1, 
                   max_significance = 0.05, 
                   reference = c("site,Tsukuba"), 
                   plot_heatmap = TRUE, 
                   plot_scatter = TRUE)
```

```{r}
signif <- read_tsv(file = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/Whole/significant_results.tsv"))
fitdata_tf <- read_tsv(file = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/Whole/features/filtered_data_norm_transformed.tsv"))
fitdata_tf <- data.frame(fitdata_tf) %>% 
  column_to_rownames(var = "feature")

signif <-signif %>% 
  left_join(data.frame(tax_table(ps_fapro_nov)) %>% 
              rownames_to_column(var = "feature"), 
            by = "feature")

show(signif)
```

**The RAs of some metabolism-related functions are positively associated with the Kawatabi common garden.**
<br>**The RA of aerobic chemoheterotrophy was negatively assoicated with the Kawtabi common garden.**

## Kawatabi

```{r,message=FALSE}
ps_fapro_k <- subset_samples(ps_fapro_nov, site == "Kawatabi")

DA_res_k <- Maaslin2(input_data = as.data.frame(t(otu_table(ps_fapro_k)))[, -29], 
                     input_metadata = data.frame(sample_data(ps_fapro_k)) %>% 
                       dplyr::select(PC1_clim), 
                     output = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/Kawatabi"), 
                     fixed_effects = c("PC1_clim"), 
                     random_effects = NULL, 
                     analysis_method = "LM", 
                     transform = "LOG", 
                     normalization = "NONE", 
                     min_abundance = 0.0, 
                     min_prevalence = 0.1, 
                     max_significance = 0.05, 
                     plot_heatmap = TRUE, 
                     plot_scatter = FALSE)
```

```{r}
signif_k <- read_tsv(file = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/Kawatabi/significant_results.tsv"))
fitdata_tf_k <- read_tsv(file = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/Kawatabi/features/filtered_data_norm_transformed.tsv"))
fitdata_tf_k <- data.frame(fitdata_tf_k) %>% 
  column_to_rownames(var = "feature")

signif_k <- signif_k %>% 
  left_join(data.frame(tax_table(ps_fapro_k)) %>% 
              rownames_to_column(var = "feature"), 
            by = "feature")

show(signif_k)
```

**The RAs of metabolism-related functions and intracellualr parasites were positively associated with climatic PC1 in Kawatabi.**
<br>**The RAs of chemoheterotrophy and ureolysis were negatively associated with climatic PC1.**

### BVOCs

```{r,message=FALSE}
ps_fapro_VOC <- subset_samples(ps_fapro_k, !is.na(PC1_ter))

DA_res_VOC <- Maaslin2(input_data = as.data.frame(t(otu_table(ps_fapro_VOC)))[, -29], 
                     input_metadata = data.frame(sample_data(ps_fapro_VOC)) %>% 
                       dplyr::select(PC1_ter, PC2_ter, PC3_ter), 
                     output = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/BVOC"), 
                     fixed_effects = c("PC1_ter", "PC2_ter", "PC3_ter"), 
                     random_effects = NULL, 
                     analysis_method = "LM", 
                     transform = "LOG", 
                     normalization = "NONE", 
                     min_abundance = 0.0, 
                     min_prevalence = 0.1, 
                     max_significance = 0.1, # lower threshold to acount for small sample size
                     plot_heatmap = TRUE, 
                     plot_scatter = FALSE)
```

```{r}
signif_v <- read_tsv(file = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/BVOC/significant_results.tsv"))
all_v <- read_tsv(file = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/BVOC/all_results.tsv"))
fitdata_tf_v <- read_tsv(file = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/BVOC/features/filtered_data_norm_transformed.tsv"))
fitdata_tf_v <- data.frame(fitdata_tf_v) %>% 
  column_to_rownames(var = "feature")

signif_v <- signif_v %>% 
  left_join(data.frame(tax_table(ps_fapro_VOC)) %>% 
              rownames_to_column(var = "feature"), 
            by = "feature")
all_v <- all_v %>% 
  left_join(data.frame(tax_table(ps_fapro_VOC)) %>% 
              rownames_to_column(var = "feature"), 
            by = "feature")

show(signif_v)
```

**The RAs of nitrogen fixation (positively associated with climatic PC1) was positively associated with terpene PC1 (less MTs emission) in Kawtabi.**
<br>**The RAs of aerobic chemoheterotrophy was positively associated with terpene PC3 (more beta-Farnesene emissions).**

## Tsukuba

```{r,message=FALSE}
ps_fapro_t <- subset_samples(ps_fapro_nov, site == "Tsukuba")

DA_res_t <- Maaslin2(input_data = as.data.frame(t(otu_table(ps_fapro_t)))[, -29], 
                     input_metadata = data.frame(sample_data(ps_fapro_t)) %>% 
                       dplyr::select(PC1_clim), 
                     output = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/Tsukuba"), 
                     fixed_effects = c("PC1_clim"), 
                     random_effects = NULL, 
                     analysis_method = "LM", 
                     transform = "LOG", 
                     normalization = "NONE", 
                     min_abundance = 0.0, 
                     min_prevalence = 0.1, 
                     max_significance = 0.05, 
                     plot_heatmap = TRUE, 
                     plot_scatter = FALSE)
```

```{r}
signif_t <- read_tsv(file = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/Tsukuba/significant_results.tsv"))
all_t <- read_tsv(file = paste0(path_out, "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/Tsukuba/all_results.tsv"))

show(signif_t)
show(all_t)
```

**No functions were significantly associated with the climatic PC1 in Tsukuba.**
<br>**See details of the entire analysis and Kawatabi-specific analysis.**

</div></details>

# Results

```{r}
show(signif)
show(signif_k)
show(signif_v)
```

**Overall, the reverse of homeground advantage effect may exist in the climate clines of bacterial functions. That is, functions that were abundant in the warmer gardens were less abundant on trees from warmer population.**

## scatter plot
###Kawatabi

```{r}
pldata_tf_k <- fitdata_tf_k %>% 
  dplyr::select(signif_k$feature) %>% 
  rownames_to_column(var = "rownames") %>% 
  left_join(data.frame(sample_data(ps_fapro_k)) %>% 
              rownames_to_column(var = "rownames") %>% 
              dplyr::select(rownames, PC1_clim), 
            by = "rownames") %>% 
  pivot_longer(names_to = "feature", values_to = "log2RA", cols = -c(rownames, PC1_clim))
```


```{r}
features_sig <- signif_k$feature
plots <- list()

for (i in 1:length(features_sig)) {
  p <- ggplot(data = pldata_tf_k %>% dplyr::filter(feature == features_sig[i]), 
              mapping = aes(x = PC1_clim, y = log2RA)) + 
    geom_point() + 
    stat_smooth(method = "glm", 
                linewidth = 0.5, 
                color = 'blue', 
                na.rm = TRUE) + 
    xlab("Climatic PC1") + 
    ylab(bquote({Log[2]} ~ "relative abundance of" ~ .(gsub("_", " ", signif_k[signif_k$feature == features_sig[i], ]$group)))) + 
    theme_classic(base_size = 12) + mytheme
  
  plots[[i]] <- p
  ggsave(filename = paste0(path_out, 
                           "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/Kawatabi/figures/", 
                           signif_k[signif_k$feature == features_sig[i], ]$group, ".png"), 
         plot = p, 
         width = 160, height = 120, units = "mm", dpi = 300)
}

names(plots) <- signif_k$group
plots[["aerobic_chemoheterotrophy"]]
```

### BVOC

```{r}
pldata_tf_v <- fitdata_tf_v %>% 
  dplyr::select(signif_v$feature) %>% 
  rownames_to_column(var = "rownames") %>% 
  left_join(data.frame(sample_data(ps_fapro_VOC)) %>% 
              rownames_to_column(var = "rownames") %>% 
              dplyr::select(rownames, PC1_ter, PC3_ter), 
            by = "rownames") %>% 
  pivot_longer(names_to = "feature", values_to = "log2RA", cols = -c(rownames, PC1_ter, PC3_ter))
```

```{r}
features_sig_v <- signif_v %>% 
  dplyr::select(feature, value)
plots_v <- list()

for (i in 1:length(features_sig_v)) {
  p <- ggplot(data = pldata_tf_v %>% dplyr::filter(feature == features_sig_v[i, ]$feature), 
              mapping = aes(x = eval(parse(text = features_sig_v[i, ]$value)), y = log2RA)) + 
    geom_point() + 
    stat_smooth(method = "glm", 
                linewidth = 0.5, 
                color = 'blue', 
                na.rm = TRUE) + 
    xlab(bquote("Terpene" ~ 
                  .(sapply(
                    str_split(features_sig_v[i, ]$value, "_"), `[`, 1)
                    )
                )
         ) + 
    ylab(bquote({Log[2]} ~ 
                  "relative abundance of" ~ 
                  .(
                    gsub("_", " ", signif_v[signif_v$feature == features_sig_v[i, ]$feature, ]$group)
                    )
                )
         ) + 
    theme_classic(base_size = 12) + mytheme
  
  plots_v[[i]] <- p
  ggsave(filename = paste0(path_out, 
                           "/231202_Sugi_phyllosphere_June_16S/processed_data/DA/Maaslin2/BVOC/figures/", 
                           signif_v[signif_v$feature == features_sig_v[i, ]$feature, ]$group, ".png"), 
         plot = p, 
         width = 160, height = 120, units = "mm", dpi = 300)
}

plots_v[[1]]
plots_v[[2]]
```

**Plots_v[[1]] is a wrong plot. Saved plot is correct. Cause unknown.**
<br>**Below is the correct plot.**

```{r}
p <- ggplot(data = pldata_tf_v %>% dplyr::filter(feature == features_sig_v[1, ]$feature), 
              mapping = aes(x = eval(parse(text = features_sig_v[1, ]$value)), y = log2RA)) + 
    geom_point() + 
    stat_smooth(method = "glm", 
                linewidth = 0.5, 
                color = 'blue', 
                na.rm = TRUE) + 
    xlab(bquote("Terpene" ~ 
                  .(sapply(
                    str_split(features_sig_v[1, ]$value, "_"), `[`, 1)
                    )
                )
         ) + 
    ylab(bquote({Log[2]} ~ 
                  "relative abundance of" ~ 
                  .(
                    gsub("_", " ", signif_v[signif_v$feature == features_sig_v[1, ]$feature, ]$group)
                    )
                )
         ) + 
    theme_classic(base_size = 12) + mytheme

show(p)
```

